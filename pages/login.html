<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#070b14"/>
<title>Dolphin Wallet Finder</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
<style>
  /* ============ Visual foundation ============ */
  :root{
    --bg:#070b14; --c1:#0ff1e7; --c2:#35a7ff; --c3:#14ff89;
    --panel:rgba(10,16,26,.70); --panel2:rgba(6,12,20,.60);
    --text:#eafaff; --text-dim:rgba(190,245,255,.9);
    --error:#ffb4b4; --ok:#8fffd3;
    --input-bg:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
    --bd:rgba(64,203,255,.28);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow-x:hidden;overflow-y:auto;
    background:
      radial-gradient(1200px 600px at 70% 20%, rgba(30,150,255,.10), transparent 60%),
      radial-gradient(1000px 600px at 10% 80%, rgba(20,255,137,.10), transparent 60%),
      linear-gradient(180deg,#060912,#05070e 40%,#04060c);
  }
  .stage{min-height:100%;position:relative;display:grid;place-items:center;padding:clamp(12px,4vw,32px)}
  .hud{
    position:relative;width:min(1080px,96vw);display:grid;grid-template-columns:1.1fr 1.2fr;border-radius:24px;overflow:hidden;
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid rgba(64,203,255,.25);
    box-shadow:inset 0 0 0 1px rgba(19,173,255,.06),0 28px 90px rgba(0,0,0,.65)
  }
  @media (max-width:980px){ .hud{grid-template-columns:1fr} }
  .brand .inner{height:100%;padding:24px;display:flex;flex-direction:column;justify-content:space-between}
  .title{
    margin:14px 0 0;font-weight:800;letter-spacing:.12em;font-size:clamp(20px,2.2vw,28px);
    background:linear-gradient(90deg,var(--c2),var(--c1),var(--c3));-webkit-background-clip:text;background-clip:text;color:transparent
  }
  .pane{padding:24px clamp(18px,4vw,36px);display:flex;flex-direction:column;gap:16px;height:100%}
  .panel-mask{position:absolute;inset:12px;border-radius:18px;border:1px dashed rgba(32,205,255,.16);pointer-events:none;mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}
  .kicker{display:inline-flex;gap:8px;align-items:center;padding:.35rem .8rem;border-radius:999px;border:1px solid rgba(0,255,240,.25);background:rgba(0,20,28,.35);font-size:.88rem;font-weight:800;width:max-content}
  .tabs{display:flex;gap:10px;margin-top:8px}
  .tab{flex:1;text-align:center;padding:.7rem 1rem;border-radius:12px;border:1px solid rgba(64,203,255,.24);background:rgba(255,255,255,.04);font-weight:900;cursor:pointer;color:var(--text)}
  .tab[aria-selected="true"]{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));border-color:rgba(53,167,255,.7)}
  .mode-toggle{display:inline-block;margin-top:6px;color:#9fefff;background:transparent;border:none;cursor:pointer;font-weight:800}
  form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:980px){ form{grid-template-columns:1fr} }
  .fg{display:flex;flex-direction:column;gap:8px;min-width:0}
  .label{font-size:.98rem;color:var(--text-dim)}
  .control{position:relative}
  .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.95}
  .input{
    width:100%;padding:14px 44px;font-size:16px;color:var(--text);border-radius:12px;border:1px solid var(--bd);
    background:var(--input-bg);outline:none;transition:border .18s ease, box-shadow .18s ease
  }
  .input::placeholder{color:rgba(220,245,255,.55)}
  .input:focus{border-color:rgba(53,167,255,.95);box-shadow:0 0 0 3px rgba(53,167,255,.28)}
  .toggle-pass{
    position:absolute;right:8px;top:50%;transform:translateY(-50%);border:none;background:transparent;color:var(--text);
    font-weight:800;padding:6px 10px;border-radius:8px;cursor:pointer
  }
  .error{min-height:16px;color:var(--error);font-size:.9rem}
  .cta{grid-column:1/-1;display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .btn{
    flex:1;min-width:140px;border:none;border-radius:14px;color:#001018;padding:16px 18px;font-weight:900;letter-spacing:.35px;text-transform:uppercase;
    background:linear-gradient(95deg,#35a7ff,#0ff1e7,#14ff89,#35a7ff);background-size:220% 100%;box-shadow:0 24px 50px rgba(53,167,255,.30), inset 0 0 0 1px rgba(0,0,0,.28)
  }
  .btn[aria-busy="true"]{opacity:.65;cursor:progress}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .footer{width:min(1080px,96vw);margin:18px auto 0;text-align:center;color:rgba(190,245,255,.85);font-size:.86rem}

  /* ============ Forgot modal ============ */
  .hidden{display:none}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px
  }
  .modal.hidden{display:none !important}
  .modal-content{
    background:#061018;padding:18px;border-radius:14px;width:100%;max-width:520px;border:1px solid rgba(90,200,255,.14);
    box-shadow:0 18px 70px rgba(0,0,0,.65);outline:none
  }
  .modal h3{margin:0 0 8px;font-size:1.15rem;color:#dff}
  .modal .row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
  .modal .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .modal .msg{color:rgba(200,255,230,.92);font-size:.98rem}
  .modal .btn-ghost{
    background:transparent;color:#dff;border:1px solid rgba(255,255,255,.12); padding:12px 14px;border-radius:10px;font-weight:700
  }
  @media (max-width:420px){
    .modal-content{padding:16px;border-radius:12px}
    .modal h3{font-size:1.05rem}
  }
  /* Helper to prevent background scroll when modal open */
  body.modal-open{height:100%;overflow:hidden}
  /* ============ Forgot modal ============ */
  .hidden{display:none}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px
  }
  .modal.hidden{display:none !important}
  .modal-content{
    background:#061018;padding:18px;border-radius:14px;width:100%;max-width:520px;border:1px solid rgba(90,200,255,.14);
    box-shadow:0 18px 70px rgba(0,0,0,.65);outline:none
  }
  .modal h3{margin:0 0 8px;font-size:1.15rem;color:#dff}
  .modal .row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
  .modal .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .modal .msg{color:rgba(200,255,230,.92);font-size:.98rem}
  .modal .btn-ghost{
    background:transparent;color:#dff;border:1px solid rgba(255,255,255,.12); padding:12px 14px;border-radius:10px;font-weight:700
  }
  @media (max-width:420px){
    .modal-content{padding:16px;border-radius:12px}
    .modal h3{font-size:1.05rem}
  }
  /* Helper to prevent background scroll when modal open */
  body.modal-open{height:100%;overflow:hidden}
</style>
</head>
<body>
  <main class="stage" id="appRoot">
    <section class="hud" role="main" aria-labelledby="brandTitle">
      <aside class="brand">
        <div class="inner">
          <div>
            <div class="logo-wrap">
              <img src="../assets/logo.png" alt="Dolphin logo"/>
            </div>
          </div>
          <h1 id="brandTitle" class="title">DOLPHIN WALLET FINDER</h1>
        </div>
      </aside>

      <section class="pane">
        <span class="panel-mask" aria-hidden="true"></span>
        <div class="kicker" id="formKicker" aria-hidden="true">Sign in to your account</div>

        <div class="tabs" role="tablist">
          <button id="tabSignIn" role="tab" class="tab" aria-selected="true">Sign In</button>
          <button id="tabSignUp" role="tab" class="tab" aria-selected="false">Sign Up</button>
        </div>

        <button class="mode-toggle" type="button" id="modeToggle">Not registered yet? Create an account</button>

        <form id="accessForm" novalidate>
          <!-- Username -->
          <div class="fg" style="grid-column:1/-1">
            <label class="label" for="username">Username</label>
            <div class="control">
              <span class="icon" aria-hidden="true">ðŸ‘¤</span>
              <input id="username" name="username" class="input" type="text" placeholder="Your username" autocomplete="username" required/>
            </div>
          </div>

          <!-- Password -->
          <div class="fg" style="grid-column:1/-1">
            <label class="label" for="password">Password</label>
            <div class="control">
              <span class="icon" aria-hidden="true">ðŸ”’</span>
              <input id="password" name="password" class="input" type="password" placeholder="Your password" autocomplete="current-password" required aria-describedby="passErr"/>
              <button type="button" class="toggle-pass" id="tgl" aria-pressed="false" aria-controls="password">Show</button>
              <small id="passErr" class="error" aria-live="polite"></small>
            </div>
          </div>

          <!-- Register-only fields -->
          <div id="registerFields" style="grid-column:1/-1; display:none">
            <div class="fg">
              <label class="label" for="confirm">Confirm Password</label>
              <div class="control">
                <span class="icon" aria-hidden="true">âœ…</span>
                <input id="confirm" name="confirm" class="input" type="password" placeholder="Repeat password" autocomplete="new-password" aria-describedby="confirmErr"/>
                <small id="confirmErr" class="error" aria-live="polite"></small>
              </div>
            </div>

            <div class="fg">
              <label class="label" for="email">Email</label>
              <div class="control">
                <span class="icon" aria-hidden="true">ðŸ“§</span>
                <input id="email" name="email" class="input" type="email" placeholder="you@example.com" autocomplete="email" aria-describedby="emailErr"/>
                <small id="emailErr" class="error" aria-live="polite"></small>
              </div>
            </div>
          </div>

          <!-- Forgot password link -->
          <div style="grid-column:1/-1; display:flex; justify-content:flex-end; align-items:center;">
            <a href="#" id="forgot-link" class="mode-toggle">Forgot password?</a>
          </div>

          <div class="cta">
            <button class="btn" type="submit" id="formBtn">Login</button>
            <div id="errorMessage" class="error" style="flex:1; min-height:unset"></div>
          </div>
        </form>
      </section>
    </section>
    <div class="footer">Â© 2025 DOLPHIN WALLET FINDER. All rights reserved.</div>
  </main>

    <!-- Forgot password modal -->
    <div id="forgot-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="forgotTitle" tabindex="-1">
        <h3 id="forgotTitle">Reset password</h3>
        <form id="forgot-form" autocomplete="off">
          <div class="row">
            <label class="label" for="forgot-username">Username</label>
            <input id="forgot-username" class="input" type="text" autocomplete="username" placeholder="Your username" required />
          </div>
          <div class="row">
            <label class="label" for="forgot-email">Email</label>
            <input id="forgot-email" class="input" type="email" autocomplete="email" placeholder="you@example.com" required />
          </div>
          <div class="row">
            <label class="label" for="forgot-newpass">New password</label>
            <input id="forgot-newpass" class="input" type="password" placeholder="New password" required />
          </div>
          <div class="row">
            <label class="label" for="forgot-newpass2">Repeat new password</label>
            <input id="forgot-newpass2" class="input" type="password" placeholder="Repeat new password" required />
          </div>
          <div class="actions" style="margin-top:8px">
            <div class="msg" id="forgot-msg" role="alert" aria-live="polite" style="flex:1"></div>
            <div class="btns">
              <button type="button" class="btn-ghost" id="forgot-cancel">Cancel</button>
              <button type="submit" class="btn" id="forgot-submit">Reset</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  
<!-- Load API helpers as a module to avoid global const collisions -->
<script type="module" src="../js/login-api.js"></script>
<script>
  // ================= Tabs / mode toggle =================
  let isRegisterMode = false;
  const tabIn = document.getElementById('tabSignIn');
  const tabUp = document.getElementById('tabSignUp');
  const modeToggle = document.getElementById('modeToggle');
  const regFields = document.getElementById('registerFields');
  const formBtn = document.getElementById('formBtn');
  const kicker = document.getElementById('formKicker');

  function applyMode(){
    const signin = !isRegisterMode;
    tabIn.setAttribute('aria-selected', signin);
    tabUp.setAttribute('aria-selected', !signin);
    regFields.style.display = isRegisterMode ? 'contents' : 'none';
    formBtn.textContent = isRegisterMode ? 'Register' : 'Login';
    modeToggle.textContent = isRegisterMode ? 'Already registered? Login' : 'Not registered yet? Create an account';
    kicker.textContent = isRegisterMode ? 'Create a new account' : 'Sign in to your account';
    const pass = document.getElementById('password');
    if (pass) pass.autocomplete = signin ? 'current-password' : 'new-password';
  }
  function toggleForm(){ isRegisterMode = !isRegisterMode; applyMode(); }
  tabIn.addEventListener('click',()=>{ isRegisterMode=false; applyMode(); });
  tabUp.addEventListener('click',()=>{ isRegisterMode=true; applyMode(); });
  modeToggle.addEventListener('click', toggleForm);
  applyMode();

  // ================= Show/Hide password =================
  (function(){
    const input=document.getElementById('password');
    const btn=document.getElementById('tgl');
    if(btn && input){
      btn.addEventListener('click',()=>{
        const isPass = input.type==='password';
        input.type = isPass ? 'text':'password';
        btn.textContent = isPass ? 'Hide':'Show';
        btn.setAttribute('aria-pressed', String(isPass));
      });
    }
  })();

  // ================= Client-side validation =================
  const USERNAME_RE = /^[A-Za-z0-9]+$/;
  const PASSWORD_RE = /^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{6,}$/;
  const EMAIL_RE = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;

  function showError(msg){
    const el = document.getElementById('errorMessage');
    if (el) el.textContent = msg || '';
    else alert(msg);
  }
  function setBusy(button, busy){
    if(!button) return;
    button.setAttribute('aria-busy', busy ? 'true':'false');
    button.disabled = !!busy;
  }

  // ================= Main access form =================
  document.getElementById('accessForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const submitBtn = document.getElementById('formBtn');
    setBusy(submitBtn, true);

    const username = document.querySelector('input[name="username"]').value.trim();
    const password = document.querySelector('input[name="password"]').value;
    const emailInput = document.querySelector('input[name="email"]');
    const confirmInput = document.querySelector('input[name="confirm"]');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = '';

    try {
      if (isRegisterMode) {
        const email = (emailInput?.value || '').trim();
        const confirm = confirmInput?.value || '';

        if (!username){ throw new Error('Username is required'); }
        if (!USERNAME_RE.test(username)){ throw new Error('Username must contain only English letters and digits.'); }
        if (!email){ throw new Error('Email is required'); }
        if (!EMAIL_RE.test(email)){ throw new Error('Invalid email format.'); }
        if (!password){ throw new Error('Password is required'); }
        if (!PASSWORD_RE.test(password)){ throw new Error('Password must be at least 6 chars and include letters and digits.'); }
        if (password !== confirm) { throw new Error('Passwords do not match!'); }

        await window.DWF_API.register(username, email, password);
        await window.DWF_API.login(username, password); // will redirect
      } else {
        if (!username){ throw new Error('Username is required'); }
        if (!password){ throw new Error('Password is required'); }
        await window.DWF_API.login(username, password); // will redirect
      }
    } catch (err) {
      showError(err.message || 'Action failed');
    } finally {
      setBusy(submitBtn, false);
    }
  });

  // ================= Forgot password modal =================
  const appRoot     = document.getElementById('appRoot');
  const forgotLink   = document.getElementById('forgot-link');
  const forgotModal  = document.getElementById('forgot-modal');
  const modalPanel   = forgotModal.querySelector('.modal-content');
  const forgotCancel = document.getElementById('forgot-cancel');
  const forgotForm   = document.getElementById('forgot-form');
  const forgotMsg    = document.getElementById('forgot-msg');

  const focusableSel = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  let lastActiveEl = null;

  function openForgotModal() {
    // Reset fields/messages
    forgotMsg.textContent = '';
    document.getElementById('forgot-username').value = '';
    document.getElementById('forgot-email').value = '';
    document.getElementById('forgot-newpass').value = '';
    document.getElementById('forgot-newpass2').value = '';

    // Show modal & update a11y state
    forgotModal.classList.remove('hidden');
    forgotModal.removeAttribute('aria-hidden');
    document.body.classList.add('modal-open');

    // Save last focus & move focus into modal
    lastActiveEl = document.activeElement;
    setTimeout(() => {
      const first = document.getElementById('forgot-username');
      (first || modalPanel).focus();
    }, 0);
  }

  function closeForgotModal() {
    // Hide modal & update a11y state
    forgotModal.classList.add('hidden');
    forgotModal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');

    // Restore focus
    if (lastActiveEl && typeof lastActiveEl.focus === 'function') lastActiveEl.focus();
  }

  // Focus trap inside modal
  function trapFocus(e){
    if (forgotModal.classList.contains('hidden')) return;
    if (!modalPanel.contains(document.activeElement)) return;
    if (e.key !== 'Tab') return;

    const focusable = modalPanel.querySelectorAll(focusableSel);
    if (!focusable.length) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault(); last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault(); first.focus();
    }
  }

  if (forgotLink) {
    forgotLink.addEventListener('click', (e) => {
      e.preventDefault();
      openForgotModal();
    });
  }
  if (forgotCancel) forgotCancel.addEventListener('click', () => closeForgotModal());

  // Close on backdrop click
  forgotModal.addEventListener('click', (e) => {
    if (e.target === forgotModal) closeForgotModal();
  });

  // Close on Escape & trap focus
  document.addEventListener('keydown', (e) => {
    const isOpen = !forgotModal.classList.contains('hidden');
    if (!isOpen) return;
    if (e.key === 'Escape') {
      e.preventDefault();
      closeForgotModal();
    } else {
      trapFocus(e);
    }
  });

  // Forgot form submit
  if (forgotForm) {
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('forgot-submit');
      submitBtn.disabled = true; submitBtn.setAttribute('aria-busy','true');
      forgotMsg.textContent = '';

      const username = document.getElementById('forgot-username').value.trim();
      const email    = document.getElementById('forgot-email').value.trim();
      const newPass  = document.getElementById('forgot-newpass').value;
      const newPass2 = document.getElementById('forgot-newpass2').value;

      if (!username){ forgotMsg.textContent = 'Username is required.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (!USERNAME_RE.test(username)){ forgotMsg.textContent = 'Username must contain only English letters and digits.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (!email){ forgotMsg.textContent = 'Email is required.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (!EMAIL_RE.test(email)){ forgotMsg.textContent = 'Invalid email format.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (!newPass){ forgotMsg.textContent = 'New password is required.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (!PASSWORD_RE.test(newPass)){ forgotMsg.textContent = 'Password must be at least 6 chars and include letters and digits.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }
      if (newPass !== newPass2){ forgotMsg.textContent = 'Passwords do not match.'; submitBtn.disabled=false; submitBtn.removeAttribute('aria-busy'); return; }

      try {
        const resp = await window.DWF_API.resetPassword(username, email, newPass);
        if (resp && resp.ok) {
          forgotMsg.textContent = 'If provided username/email are valid, password has been updated.';
          setTimeout(() => closeForgotModal(), 900);
        } else {
          forgotMsg.textContent = 'Reset request processed.';
          setTimeout(() => closeForgotModal(), 900);
        }
      } catch (err) {
        forgotMsg.textContent = err.message || 'Server error during reset.';
      } finally {
        submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy');
      }
    });
  }

  // ================= Smart auto-redirect if already logged in =================
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) return;

      // Determine role
      let role = localStorage.getItem('role');
      if (!role) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1] || '{}'));
          role = payload.role || 'user';
          localStorage.setItem('role', role);
        } catch (_) { role = 'user'; }
      }

      if (role === 'admin') {
        window.location.href = "/pages/admin-licenses.html";
        return;
      }

      if (window.DWF_API && typeof window.DWF_API.smartRedirectAfterLogin === 'function') {
        await window.DWF_API.smartRedirectAfterLogin();
      }
    } catch (_) { /* stay on login if anything fails */ }
  });
</script>
</body>
</html>
